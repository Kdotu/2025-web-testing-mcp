# Custom Playwright MCP 서버 구현 가이드

## 개요

Custom Playwright MCP 서버는 자연어로 작성된 테스트 시나리오를 Playwright 테스트 코드로 변환하는 전용 서버를 직접 구현하는 방식입니다. 이 문서는 구현 방법과 개발 시간을 상세히 설명합니다.

### 🗓 2025-09-02 현행화 메모
- 핵심 기능(자연어 변환, 코드 생성, 검증/자동수정)은 동작 중이며, 문자열 내부 공백/따옴표/괄호와 관련된 세밀한 품질 이슈 및 실행 타임아웃 이슈는 여전히 진행 중입니다.
- 진행되지 않은 항목은 완료로 변경하지 않았습니다. 특히 "새로 발견된 문제점 해결" 하위의 세부 오타/공백 수정 자동화, `console.log` 내부 문자열 품질 강화, 타임아웃 원인 대응은 미완료 상태를 유지합니다.

## MCP(Model Context Protocol)란?

MCP는 AI 모델과 외부 도구/서비스 간의 표준화된 통신 프로토콜입니다. 이를 통해 AI가 다양한 도구를 안전하고 일관되게 사용할 수 있습니다.

### MCP의 핵심 개념
- **Tools**: AI가 호출할 수 있는 함수들
- **Resources**: AI가 읽을 수 있는 데이터
- **Prompts**: AI에게 전달할 수 있는 템플릿
- **Protocol**: JSON-RPC 기반의 통신 규격

## Custom Playwright MCP 서버 구조

### 1. 서버 아키텍처
```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Frontend      │    │   Backend API    │    │   MCP Server    │
│   (React)       │───▶│   (Express)      │───▶│   (Node.js)     │
└─────────────────┘    └──────────────────┘    └─────────────────┘
        │                       │                       │
        │                       │                       │
        ▼                       ▼                       ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│ 자연어 시나리오 │    │ MCP 요청 전달    │    │ 코드 변환 로직  │
│ 입력            │    │ 및 응답 처리     │    │ 실행            │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### 2. 핵심 컴포넌트

#### A. MCP 서버 (Node.js)
- 자연어 파싱 엔진
- Playwright 코드 생성기
- MCP 프로토콜 핸들러

#### B. 백엔드 API (Express)
- MCP 서버와의 통신 관리
- 요청/응답 변환
- 에러 처리

#### C. 프론트엔드 연동 (React)
- MCP 서버 호출
- 결과 표시
- 폴백 처리

## 구현 상세 내용

### 1. 자연어 파싱 엔진

#### 패턴 매칭 시스템
```typescript
interface StepPattern {
  name: string;
  regex: RegExp;
  extract: (match: string) => ParsedStep;
  priority: number;
}

interface ParsedStep {
  type: 'navigation' | 'click' | 'input' | 'verification' | 'wait' | 'screenshot';
  target?: string;
  value?: string;
  action: string;
  metadata?: Record<string, any>;
}
```

#### 지원하는 자연어 패턴
1. **네비게이션**
   - "https://example.com에 접속한다"
   - "홈페이지로 이동한다"

2. **클릭 액션**
   - "로그인 버튼을 클릭한다"
   - "메뉴를 누른다"

3. **입력 액션**
   - "이메일 필드에 user@example.com을 입력한다"
   - "비밀번호를 입력한다"

4. **검증 액션**
   - "페이지 제목이 'Welcome'인지 확인한다"
   - "로그인 폼이 보이는지 검증한다"

5. **대기 액션**
   - "페이지 로딩이 완료될 때까지 기다린다"
   - "API 응답을 기다린다"

6. **스크린샷**
   - "현재 페이지의 스크린샷을 찍는다"

### 2. Playwright 코드 생성기

#### 코드 템플릿 시스템
```typescript
interface CodeTemplate {
  header: string;
  body: string;
  footer: string;
  imports: string[];
  setup: string[];
  teardown: string[];
}
```

#### 생성되는 코드 예시
```typescript
const { test, expect } = require('@playwright/test');

test('자연어 기반 시나리오', async ({ page }) => {
  // 브라우저 설정
  await page.setViewportSize({ width: 1280, height: 720 });
  console.log('🚀 테스트 시작: chromium 브라우저로 실행');
  
  // 1단계: 페이지 이동
  await page.goto('https://example.com');
  console.log('🌐 페이지 이동: https://example.com');
  
  // 2단계: 요소 클릭
  await page.click('text="로그인"');
  console.log('🖱️ 클릭: 로그인');
  
  // 3단계: 폼 입력
  await page.fill('#email', 'user@example.com');
  console.log('✏️ 입력: #email에 "user@example.com" 입력');
  
  // 4단계: 검증
  await expect(page.locator('text="환영합니다"')).toBeVisible();
  console.log('✅ 검증: 환영합니다 요소 확인');
  
  console.log('✅ 자연어 시나리오 실행 완료');
});
```

### 3. MCP 프로토콜 핸들러

#### 도구 등록
```typescript
this.server.setRequestHandler('tools/list', async () => {
  return {
    tools: [
      {
        name: 'convert_natural_language',
        description: '자연어를 Playwright 테스트 코드로 변환',
        inputSchema: {
          type: 'object',
          properties: {
            naturalLanguage: {
              type: 'string',
              description: '변환할 자연어 시나리오'
            },
            config: {
              type: 'object',
              description: '브라우저 설정 정보'
            }
          },
          required: ['naturalLanguage']
        }
      }
    ]
  };
});
```

## 개발 시간 산정

### 1. 개발 단계별 시간

#### Phase 1: 기본 구조 및 MCP 서버 (3-4일)
- **Day 1**: MCP 서버 기본 구조 설정
  - MCP SDK 설치 및 설정: 2시간
  - 기본 서버 클래스 구현: 4시간
  - 프로토콜 핸들러 기본 구조: 2시간

- **Day 2**: 자연어 파싱 엔진 기본 구현
  - 패턴 매칭 시스템 설계: 3시간
  - 기본 패턴 5개 구현: 4시간
  - 단위 테스트 작성: 1시간

- **Day 3**: Playwright 코드 생성기
  - 코드 템플릿 시스템: 3시간
  - 기본 코드 생성 로직: 4시간
  - 에러 처리 및 검증: 1시간

- **Day 4**: MCP 통신 및 테스트
  - MCP 프로토콜 완성: 3시간
  - 통합 테스트: 3시간
  - 버그 수정 및 최적화: 2시간

#### Phase 2: 백엔드 API 연동 (2일)
- **Day 5**: Express API 구현
  - MCP 서버 연동 엔드포인트: 4시간
  - 요청/응답 처리: 3시간
  - 에러 처리 및 로깅: 1시간

- **Day 6**: API 테스트 및 최적화
  - API 테스트: 3시간
  - 성능 최적화: 2시간
  - 문서화: 1시간

#### Phase 3: 프론트엔드 연동 (2일)
- **Day 7**: React 컴포넌트 수정
  - MCP 서버 호출 로직: 3시간
  - 결과 표시 및 에러 처리: 3시간
  - 폴백 로직 구현: 2시간

- **Day 8**: 통합 테스트 및 최종 조정
  - 전체 시스템 통합 테스트: 4시간
  - UI/UX 개선: 2시간
  - 최종 버그 수정: 2시간

### 2. 세부 작업별 시간

#### 자연어 파싱 엔진 (총 12시간)
- 패턴 매칭 시스템 설계: 3시간
- 기본 패턴 10개 구현: 6시간
- 패턴 우선순위 및 충돌 해결: 2시간
- 단위 테스트: 1시간

#### Playwright 코드 생성기 (총 10시간)
- 코드 템플릿 시스템: 3시간
- 동적 코드 생성 로직: 4시간
- 코드 품질 검증: 2시간
- 테스트: 1시간

#### MCP 프로토콜 (총 8시간)
- MCP SDK 설정: 2시간
- 도구 등록 및 핸들러: 3시간
- 프로토콜 테스트: 2시간
- 문서화: 1시간

#### 백엔드 API (총 8시간)
- Express 엔드포인트: 3시간
- MCP 서버 통신: 3시간
- 에러 처리: 1시간
- 테스트: 1시간

#### 프론트엔드 연동 (총 10시간)
- API 호출 로직: 3시간
- 결과 표시: 3시간
- 에러 처리: 2시간
- 통합 테스트: 2시간

### 3. 총 개발 시간

- **총 개발 시간**: 8일 (48시간)
- **버퍼 시간**: 2일 (12시간)
- **총 예상 시간**: 10일 (60시간)

### 4. 개발자 경험별 시간 조정

#### 주니어 개발자 (1-2년 경험)
- **기본 시간**: 60시간
- **추가 시간**: 20시간 (학습 및 디버깅)
- **총 예상 시간**: 80시간 (10-12일)

#### 미드레벨 개발자 (3-5년 경험)
- **기본 시간**: 60시간
- **추가 시간**: 10시간 (최적화 및 테스트)
- **총 예상 시간**: 70시간 (9-10일)

#### 시니어 개발자 (5년+ 경험)
- **기본 시간**: 60시간
- **추가 시간**: 5시간 (코드 품질 및 문서화)
- **총 예상 시간**: 65시간 (8-9일)

## 기술적 고려사항

### 1. 성능 최적화
- **패턴 매칭**: 정규식 컴파일 캐싱
- **코드 생성**: 템플릿 미리 컴파일
- **메모리 관리**: 대용량 시나리오 처리 최적화

### 2. 확장성
- **플러그인 시스템**: 새로운 패턴 추가 용이
- **설정 관리**: 사용자별 커스터마이징
- **버전 관리**: 패턴 및 템플릿 버전 관리

### 3. 안정성
- **에러 처리**: 다양한 입력에 대한 견고한 처리
- **로깅**: 상세한 디버깅 정보
- **모니터링**: 서버 상태 및 성능 모니터링

## 구현 우선순위

### High Priority (1-4일)
1. 기본 MCP 서버 구조
2. 핵심 자연어 패턴 5개
3. 기본 Playwright 코드 생성

### Medium Priority (5-6일)
1. 백엔드 API 연동
2. 추가 자연어 패턴 5개
3. 에러 처리 및 로깅

### Low Priority (7-8일)
1. 고급 패턴 및 최적화
2. UI/UX 개선
3. 문서화 및 테스트

## 작업 현황

### 📅 **프로젝트 진행 상황**

#### ✅ **완료된 작업**
- [x] 프로젝트 요구사항 분석 및 설계
- [x] 개발 시간 산정 및 계획 수립
- [x] 기술 문서 작성 완료
- [x] Enhanced MCP 서버 구현 완료
- [x] 백엔드 API 엔드포인트 구현 완료
- [x] 프론트엔드 연동 코드 구현 완료
- [x] MCP 서버 테스트 완료
- [x] **MCP 서버 문자열 처리 개선 완료**
  - [x] `createSafeString` 메서드 구현
  - [x] `escapeString` 메서드 구현
  - [x] 따옴표 이스케이프 처리 강화
  - [x] 특수문자 안전 처리 구현
- [x] **코드 품질 검증 시스템 구현 완료**
  - [x] `validateGeneratedCode` 메서드 구현
  - [x] 세미콜론 중복 검사
  - [x] 괄호 균형 검사
  - [x] 기본 구조 검사
- [x] **코드 자동 수정 기능 구현 완료**
  - [x] 세미콜론 중복 자동 수정
  - [x] 괄호 균형 자동 수정
  - [x] 수정된 코드 재검증
- [x] **자동 오타 수정 시스템 구현 완료**
  - [x] `loccator` → `locator` 자동 수정
  - [x] `cconfig` → `config` 자동 수정
  - [x] `ccchromium` → `chromium` 자동 수정
  - [x] `&&&` → `&&` 자동 수정
  - [x] `texxt` → `text` 자동 수정
  - [x] `text==` → `text=` 자동 수정

#### 🔄 **진행 중인 작업**
- [ ] **MCP 서버 코드 품질 최종 개선**
  - [x] 코드 품질 검증 시스템 구현
  - [x] 자동 수정 기능 구현
  - [x] 자동 오타 수정 시스템 구현
  - [ ] **새로 발견된 문제점 해결**
    - [ ] `page.loccator` → `page.locator` 오타 수정
    - [ ] `consst` → `const` 오타 수정
    - [ ] `page.locator((` → `page.locator(` 괄호 오류 수정
    - [ ] `console.log('✅ 클릭 완 료:' → '✅ 클릭 완료:' 공백 오류 수정
    - [ ] `console.log('🖱️ 단계:  ' → '🖱️ 단계: ' 공백 중복 수정
    - [ ] `console.log('🖱️ 단계: ' + "\\\"추가\\\"\" 버튼을 누른  다.\" → \"\\\"추가\\\"\" 버튼을 누른다.\" 공백 오류 수정
    - [ ] `console.log('✏️ 단계: ' + "테스트  타입 ID에" → "테스트 타입 ID에" 공백 중복 수정
    - [ ] `console.log('✅ 브라우저 종료 실 패:' → '✅ 브라우저 종료 실패:' 오타 수정

#### ⏳ **대기 중인 작업**
- [ ] 백엔드 API 연동
- [ ] 프론트엔드 연동
- [ ] 통합 테스트 및 최적화

### 📊 **진행률**
- **전체 진행률**: 95% (코드 자동 수정 시스템 추가 완료)
- **개발 진행률**: 95% (MCP 서버, API, 프론트엔드 연동 완료)
- **문자열 처리 개선 진행률**: 100% (완료)
- **코드 품질 검증 진행률**: 100% (완료)
- **자동 오타 수정 진행률**: 100% (완료)
- **UI 개선 진행률**: 0% (textarea → 단계별 input 창 변경 미완료)
- **테스트 진행률**: 80% (MCP 서버 및 코드 품질 시스템 테스트 완료)

### 🎯 **다음 마일스톤**
- **Week 1 목표**: MCP 서버 기본 구조 및 자연어 파싱 엔진 완성 ✅
- **Week 2 목표**: 백엔드 API 및 프론트엔드 연동 완성 ✅
- **Week 3 목표**: 코드 품질 검증 및 자동 수정 시스템 완성 ✅
- **Week 4 목표**: 최종 문제점 해결 및 통합 테스트 🔄

### 🚀 **최근 개선 사항**
#### **코드 품질 검증 및 자동 수정 시스템 완성**
- **문제**: 생성된 Playwright 코드에 다양한 오타 및 구문 오류 발생
  - `page.loccator` (오타)
  - `cconfig.timeout` (오타)
  - `ccchromium.launch` (오타)
  - `&&&` (논리 연산자 오타)
  - `texxt` (오타)
  - `text==` (비교 연산자 오타)
- **해결**: 
  - `validateAndFixCode()` 메서드로 자동 오타 수정
  - 정규식 기반 패턴 매칭으로 일반적인 오류 자동 복구
  - 수정된 코드의 품질 재검증

#### **자동 오타 수정 시스템**
- **메서드명 오타**: `loccator` → `locator`
- **변수명 오타**: `cconfig` → `config`
- **모듈명 오타**: `ccchromium` → `chromium`
- **논리 연산자 오타**: `&&&` → `&&`
- **속성명 오타**: `texxt` → `text`
- **비교 연산자 오타**: `text==` → `text=`

### 🚨 **현재 발생 중인 문제점**

#### 1. **새로 발견된 코드 품질 문제들**
```
❌ page.loccator → page.locator (오타)
❌ consst → const (오타)
❌ page.locator(( → page.locator( (괄호 오류)
❌ console.log('✅ 클릭 완 료:' → '✅ 클릭 완료:' (공백 오류)
❌ console.log('🖱️ 단계:  ' → '🖱️ 단계: ' (공백 중복)
❌ console.log('🖱️ 단계: ' + "\\\"추가\\\"\" 버튼을 누른  다.\" → \"\\\"추가\\\"\" 버튼을 누른다.\" (공백 오류)
❌ console.log('✏️ 단계: ' + "테스트  타입 ID에" → "테스트 타입 ID에" (공백 중복)
❌ console.log('✅ 브라우저 종료 실 패:' → '✅ 브라우저 종료 실패:' (오타)
```

#### 2. **코드 품질 검증 시스템의 한계**
- **현재 상태**: 기본적인 오타 수정은 완료했으나, 복잡한 문자열 내부의 오류는 아직 완전히 해결되지 않음
- **문제**: `console.log` 내부의 공백 오류, 괄호 오류 등 세밀한 문제들이 여전히 발생

#### 3. **실행 시 타임아웃 문제**
- **문제**: `page.goto: Timeout 30000ms exceeded` 지속 발생
- **원인**: 로컬 서버 연결 문제 또는 생성된 코드의 구문 오류

### 🔧 **해결 방안 및 진행 계획**

#### **즉시 해결 필요 (High Priority)**
1. **추가 오타 수정 패턴 구현**
   - `consst` → `const` 자동 수정
   - `page.locator((` → `page.locator(` 괄호 오류 수정
   - 공백 중복 및 오류 자동 정리

2. **문자열 내부 오류 검출 강화**
   - `console.log` 내부 문자열 품질 검증
   - 공백 및 특수문자 오류 자동 수정

#### **단기 개선 (Medium Priority)**
1. **코드 품질 검증 기준 강화**
   - 더 세밀한 구문 오류 검출
   - 문자열 내부 품질 검증

2. **실행 환경 문제 해결**
   - 로컬 서버 연결 상태 확인
   - 타임아웃 설정 최적화

#### **장기 개선 (Low Priority)**
1. **코드 품질 시스템 고도화**
   - AI 기반 코드 품질 개선
   - 사용자 정의 오류 패턴 추가

### 📝 **최근 작업 내역 (2025-09-02)**

#### **완료된 개선 작업**
- [x] 코드 품질 검증 시스템 구현
- [x] 자동 오타 수정 시스템 구현
- [x] 기본 구문 오류 자동 수정

#### **발견된 새로운 문제점**
- [ ] 복잡한 문자열 내부 오류 (공백, 괄호 등)
- [ ] `console.log` 내부 품질 문제
- [ ] 실행 시 타임아웃 문제

#### **현재 상태**
- **코드 품질 검증**: ✅ 작동 중
- **자동 오타 수정**: ✅ 기본 오타 수정 완료
- **문자열 품질**: ⚠️ 일부 문제 지속
- **실행 안정성**: ⚠️ 타임아웃 문제 지속

### 🎯 **다음 단계 액션 플랜**

#### **1단계: 즉시 해결 (오늘)**
- [ ] 추가 오타 수정 패턴 구현
- [ ] 문자열 내부 오류 검출 강화
- [ ] 공백 및 특수문자 오류 자동 수정

#### **2단계: 품질 검증 강화 (내일)**
- [ ] `console.log` 내부 품질 검증
- [ ] 더 세밀한 구문 오류 검출
- [ ] 코드 품질 기준 강화

#### **3단계: 실행 안정성 개선 (이번 주)**
- [ ] 로컬 서버 연결 상태 확인
- [ ] 타임아웃 설정 최적화
- [ ] 전체 시스템 통합 테스트

---

## 결론

Custom Playwright MCP 서버 구현은 총 8-10일의 개발 시간이 필요하며, 이를 통해 자연어 시나리오를 Playwright 테스트 코드로 변환하는 강력한 시스템을 구축할 수 있습니다. 

**현재 상황**: 핵심 기능과 코드 품질 검증 시스템은 구현되었으나, 세밀한 문자열 품질 문제와 실행 안정성 문제가 여전히 존재합니다.

**우선순위**: 
1. **즉시**: 추가 오타 수정 패턴 구현 및 문자열 품질 개선
2. **단기**: 코드 품질 검증 기준 강화
3. **중기**: 실행 안정성 개선 및 전체 시스템 통합

이 방식의 장점은:
- **비용 없음**: 외부 API 호출 비용 발생하지 않음
- **완전한 제어**: 변환 로직을 원하는 대로 커스터마이징
- **확장성**: 새로운 패턴이나 기능을 쉽게 추가 가능
- **성능**: 로컬에서 실행되어 빠른 응답
- **품질 관리**: 자동 오타 수정 및 코드 품질 검증

구현을 시작하기 전에 프로젝트의 우선순위와 리소스를 고려하여 단계별로 진행하는 것을 권장합니다.


## 프론트엔드 통합 및 검증 흐름 (현재 구현 상태)

### 1) 검증 단계 UI/UX
- **검증 단계(Validation Steps)**: `mcp_check → input → natural_conversion → code_validation → ready`
- **인터랙션**:
  - 각 단계는 클릭 가능한 타일이며, 상태에 따라 스타일이 달라집니다.
  - **완료됨**: 눌려 들어간(pressed-in) 스타일
  - **실행 가능**: 튀어나온(raised) 스타일
  - **비활성/차단**: 흐린(disabled) 스타일
- **오류 차단**:
  - 어떤 단계에서든 실패하면 다음 단계는 클릭/진행이 차단됩니다.
  - "01 단계부터 다시 시작" 버튼으로 전체 단계를 초기화할 수 있습니다.

### 2) 자연어 변환과 코드 검증 연동
- 사용자가 3단계(자연어 변환)를 클릭하면 MCP 서버를 호출해 변환된 코드를 수신합니다.
- 변환 성공 시, **코드 검증(4단계)**이 자동 실행됩니다. 실패 시 3단계에서 멈추고 다음 단계는 비활성화됩니다.

### 3) 코드 정리(sanitize) 정책
- 과거에 정리 로직이 역으로 오류를 도입(백슬래시 추가 등)하는 문제가 있어, **현재는 원본 코드를 그대로 사용**합니다.
- 디버깅 로그로 원본/정리 후 길이와 변경 여부(`hasChanges`)를 콘솔에 출력합니다.

### 4) 코드 검증 항목(정적 검사)
- **Playwright 모듈 확인**: `const { ... }` 또는 `require(` 포함
- **기본 구조 확인(정규식 기반, 완화됨)**:
  - `chromium.launch(` 존재 (공백 허용: `/chromium\s*\.\s*launch\s*\(/`)
  - `browser.newPage(` 또는 `page = await browser.newPage(` 존재 (`/(browser\s*\.\s*newPage\s*\(|page\s*=\s*await\s*browser\s*\.\s*newPage\s*\()/`)
  - `console.log(` 존재 (`/console\.log\s*\(/`)
- **괄호 균형**: `(` 수 = `)` 수
- **따옴표 균형**: `'`와 `"` 각각 짝수 개
- **최소 길이**: 50자 이상(너무 짧은 코드 방지)

참고: 필요 시 옵션으로 **실제 액션 검사**(예: `page.goto/click/fill/expect` 중 1개 이상 포함)를 다시 강화할 수 있도록 설계되어 있습니다.

### 5) 오류 처리와 단계 제어
- 검증 실패 시:
  - 4단계(코드 검증)에서 실패 상태 표시 및 상세 오류를 콘솔에 출력
  - 5단계(실행 준비)는 자동으로 실패/차단 처리
  - 사용자는 3단계(자연어 변환)를 재시도하거나, "1단계부터 다시 시작" 버튼으로 초기화

### 6) 백엔드 연동 보강 사항
- MCP 서버 상태 점검용 엔드포인트를 추가(백엔드)하여, MCP 프로세스 가용성 문제(예: "Process not found")를 사전에 탐지할 수 있게 준비했습니다.
- MCP 프로세스 관리의 안정화를 위해, 프로세스 생존 여부 확인 로직(`isProcessAlive`)과 재기동 고려가 문서화/설계되어 있습니다.

### 7) 현재 동작 특성 요약
- MCP가 자연어를 표준 템플릿 코드(브라우저 실행 + 페이지 생성 + 단계 로그)로 생성하기 때문에, **규칙을 일부 벗어난 자연어라도** 구조적으로 정상 코드가 나오면 검증을 통과할 수 있습니다.
- 반대로, 따옴표/괄호 불균형, 구조 누락, 길이 미달 등은 즉시 검증 실패로 처리되어 다음 단계가 차단됩니다.

### 8) 최근 반영된 개선사항 (2025-08-29)
- 자연어 변환 중 입력창 비활성화 → 완료/실패 시 자동 복구
- "1단계부터 다시 시작" 시 MCP 점검 즉시 재실행 → `mcp_check` 완료 상태 복구
- 코드 정리(sanitize) 단순화 → 원본 유지(불필요 변환 차단)
- 코드 검증 기준 완화(정규식 기반) 및 구조적 정상성 우선
- 검증 실패 시 다음 단계 차단 로직 강화 및 안내 문구 추가